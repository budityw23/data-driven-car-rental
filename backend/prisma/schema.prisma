// ============================================
// Prisma Schema for Car Rental Application
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN
}

enum CarType {
  SUV
  SEDAN
  HATCHBACK
  MPV
  VAN
}

enum Transmission {
  AT
  MT
}

enum FuelType {
  GAS
  DIESEL
  EV
}

enum CarStatus {
  ACTIVE
  INACTIVE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  PICKED_UP
  RETURNED
  CANCELLED
}

// ============================================
// MODELS
// ============================================

/// User account for customers and admins
model User {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         UserRole  @default(CUSTOMER)

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  bookings     Booking[]
  auditLogs    AuditLog[]

  @@map("users")
}

/// Car in the rental fleet
model Car {
  id           String       @id @default(uuid())
  brand        String       @db.VarChar(100)
  model        String       @db.VarChar(100)
  year         Int
  type         CarType
  seats        Int
  transmission Transmission
  fuel         FuelType
  dailyPrice   Decimal      @map("daily_price") @db.Decimal(10, 2)
  status       CarStatus    @default(ACTIVE)
  images       String[]

  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  bookings     Booking[]

  // Indexes for filtering
  @@index([type])
  @@index([status])
  @@index([dailyPrice])
  @@index([seats])
  @@index([transmission])
  @@index([fuel])
  @@map("cars")
}

/// Pickup/dropoff location
model Location {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(255)
  address   String?  @db.Text
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  bookingsPickup  Booking[] @relation("PickupLocation")
  bookingsDropoff Booking[] @relation("DropoffLocation")

  @@map("locations")
}

/// Optional service/product for bookings
model Addon {
  id              String         @id @default(uuid())
  name            String         @unique @db.VarChar(255)
  description     String?        @db.Text
  pricePerBooking Decimal        @map("price_per_booking") @db.Decimal(10, 2)
  isActive        Boolean        @default(true) @map("is_active")

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  bookingAddons   BookingAddon[]

  @@map("addons")
}

/// Car rental booking
model Booking {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  carId             String        @map("car_id")
  pickupLocationId  String        @map("pickup_location_id")
  dropoffLocationId String        @map("dropoff_location_id")

  startDate         DateTime      @map("start_date") @db.Date
  endDate           DateTime      @map("end_date") @db.Date
  days              Int

  basePrice         Decimal       @map("base_price") @db.Decimal(12, 2)
  addonPrice        Decimal       @map("addon_price") @db.Decimal(12, 2) @default(0)
  totalPrice        Decimal       @map("total_price") @db.Decimal(12, 2)

  status            BookingStatus @default(PENDING)
  cancelReason      String?       @map("cancel_reason") @db.Text

  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  user              User          @relation(fields: [userId], references: [id])
  car               Car           @relation(fields: [carId], references: [id])
  pickupLocation    Location      @relation("PickupLocation", fields: [pickupLocationId], references: [id])
  dropoffLocation   Location      @relation("DropoffLocation", fields: [dropoffLocationId], references: [id])
  bookingAddons     BookingAddon[]

  // Indexes for queries
  @@index([userId])
  @@index([carId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([carId, startDate, endDate]) // Critical for availability check
  @@index([createdAt])
  @@map("bookings")
}

/// Junction table for booking add-ons (with price snapshot)
model BookingAddon {
  id        String  @id @default(uuid())
  bookingId String  @map("booking_id")
  addonId   String  @map("addon_id")
  price     Decimal @db.Decimal(10, 2) // Snapshot of addon price at booking time

  // Relations
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  addon     Addon   @relation(fields: [addonId], references: [id])

  @@unique([bookingId, addonId])
  @@index([bookingId])
  @@map("booking_addons")
}

/// Audit log for tracking changes
model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?  @map("actor_id")
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id")
  action     String   @db.VarChar(50)
  beforeJson Json?    @map("before_json")
  afterJson  Json?    @map("after_json")

  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  actor      User?    @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_logs")
}
